<div class="unit-content">
<body id="apex_testing_data_learning_objectives"><a name="apex_testing_data_learning_objectives"></a>
<div class="nested0">
<h2 class="helpHead2" id="Tdxn4tBK-heading1"><span class="ph" id="topic-title"><a name="topic-title"></a>Learning Objectives</span></h2>
<div class="body">
<div class="p" id="p2"><a name="p2"></a>After completing this unit, you'll be able to: <ul class="ul bulletList">
<li class="li">Create a test utility class.</li>
<li class="li">Use a test utility method to set up test data for various test cases.</li>
<li class="li">Execute all test methods in a class.</li>
</ul>
</div>
</div>
</div>
<div class="topic concept nested0" id="apex_testing_data" lang="en-us" xml:lang="en-us" xmlns:xml="http://www.w3.org/XML/1998/namespace"><a name="apex_testing_data"></a>
<h2 class="helpHead2" id="Tdxn4tBK-heading2"><span class="ph" id="topic-title"><a name="topic-title"></a>Create Test Data for Apex Tests</span></h2>
<div class="body conbody"><div class="shortdesc">Use test utility classes to add reusable methods for test data setup.</div>
<div class="section"><h3 class="helpHead3" id="Tdxn4tBK-heading3">Prerequisites</h3>
<p class="p">Complete the prerequisites in the previous unit, <a class="xref" href="https://trailhead.salesforce.com/force_com_dev_beginner/apex_testing/apex_testing_triggers" target="_blank">Testing Apex Triggers</a>, if you haven’t done
                so already. </p>
</div>
<div class="section"><h3 class="helpHead3" id="Tdxn4tBK-heading4">Adding a Test Utility Class</h3>
<p class="p">Let’s refactor the previous test method by replacing test data creation with a call to a
                utility class method. First, you need to create the test utility class.</p>
<p class="p">The <samp>TestDataFactory</samp> class is a special type of class—it is a public
        class that is annotated with <samp>isTest</samp> and can be accessed only from a running
        test. Test utility classes contain methods that can be called by test methods to perform
        useful tasks, such as setting up test data. Test utility classes are excluded from the org’s
        code size limit.</p>
<p class="p">To add the <samp>TestDataFactory</samp> class:</p>
<ol class="ol enumList">
<li class="li">In the Developer Console, click <span class="ph menucascade"><strong class="ph uicontrol">File</strong> | <strong class="ph uicontrol">New</strong> | <strong class="ph uicontrol">Apex Class</strong></span>, and enter <kbd class="ph userinput">TestDataFactory</kbd> for the class
                    name, and then click <strong class="ph uicontrol">OK</strong>.</li>
<li class="li">Replace the default class body with the
                    following.<div class="codeblock"><pre>@isTest
public class TestDataFactory {
    public static List&lt;Account&gt; createAccountsWithOpps(Integer numAccts, Integer numOppsPerAcct) {
        List&lt;Account&gt; accts = new List&lt;Account&gt;();
        
        for(Integer i=0;i&lt;numAccts;i++) {
            Account a = new Account(Name='TestAccount' + i);
            accts.add(a);
        }
        insert accts;
        
        List&lt;Opportunity&gt; opps = new List&lt;Opportunity&gt;();
        for (Integer j=0;j&lt;numAccts;j++) {
            Account acct = accts[j];
            // For each account just inserted, add opportunities
            for (Integer k=0;k&lt;numOppsPerAcct;k++) {
                opps.add(new Opportunity(Name=acct.Name + ' Opportunity ' + k,
                                       StageName='Prospecting',
                                       CloseDate=System.today().addMonths(1),
                                       AccountId=acct.Id));
            }
        }
        // Insert all opportunities for all accounts.
        insert opps;
        
        return accts;
    }
}</pre></div>
</li>
</ol>
<p class="p">This test utility class contains one static method, <samp>createAccountsWithOpps()</samp>, which accepts the number of accounts (held
                in the <samp>numAccts</samp> parameter) and the number of
                related opportunities to create for each account (held in the <samp>numOppsPerAcct</samp> parameter). The first loop in the
                method creates the specified number of accounts and stores them in the <samp>accts</samp> list variable. After the first loop, the
                    <samp>insert()</samp> DML statement is called to
                create all accounts in the list in the database.</p>
<p class="p">The second loop creates the opportunities. Because each group of opportunities are
                linked to one account, the outer loop iterates through accounts and contains a
                nested loop that creates related opportunities for the current account. The next
                time the nested loop is run, opportunities are added to the same list using the
                    <samp>add()</samp> method. Opportunities are linked
                to their parent accounts using the <span class="keyword parmname">AccountId</span> field. The total
                number of all opportunities that are created is the product of the number of
                opportunities with the number of accounts (<samp>numOppsPerAcct*numAccts</samp>). Next, the <samp>insert()</samp> DML statement is efficiently called outside the loop to
                create all opportunities in the collection for all accounts in one call only.</p>
<p class="p">Finally, this method returns a list of the new accounts.</p>
<div class="box message info"><div class="inner"><div class="bd"><div class="media"><img alt="Note" class="img mtm" src="https://res.cloudinary.com/hy4kyit2a/image/upload/doc/trailhead/en-usb473bb5ea1b7e61dfb07e6a7e547de6b.gif"/><div class="mediaBd"><h4 class="mbs">Note</h4><p>Even though this method doesn’t return the related opportunities, you can get
                those records by writing a SOQL query that makes use of the existing relationship
                between Account and Opportunity, such as the query used in the trigger in <a class="xref" href="https://developer.salesforce.com/en/trailhead/force_com_dev_beginner/apex_testing/apex_testing_triggers#Tdxn4tBK-heading2" target="_blank">Testing Apex
                    Triggers</a>.</p></div></div></div></div></div>
</div>
<div class="section"><h3 class="helpHead3" id="Tdxn4tBK-heading5">Calling Utility Methods for Test Data Creation</h3>
<p class="p">Now that you’ve added the test utility class, modify the test class to take advantage of
                this class. In the <samp>TestAccountDeletion</samp> class, replace the block
                that starts with <samp>// Test data setup</samp> and ends with <samp>insert
                    opp;</samp> with:</p>
<div class="codeblock"><pre>        // Test data setup
        // Create one account with one opportunity by calling a utility method
        Account[] accts = TestDataFactory.createAccountsWithOpps(1,1);</pre></div>
<p class="p">The array returned by the <samp>TestDataFactory.createAccountsWithOpps(1,1)</samp> call contains one Account
                sObject.</p>
<p class="p">Here’s the modified test method. A shorter version!</p>
<div class="codeblock"><pre>@isTest
private class TestAccountDeletion {

    @isTest static void TestDeleteAccountWithOneOpportunity() {
        // Test data setup
        // Create one account with one opportunity by calling a utility method
        Account[] accts = TestDataFactory.createAccountsWithOpps(1,1);
        
        // Perform test
        Test.startTest();
        Database.DeleteResult result = Database.delete(accts[0], false);
        Test.stopTest();

        // Verify that the deletion should have been stopped by the trigger,
        // so check that we got back an error.
        System.assert(!result.isSuccess());
        System.assert(result.getErrors().size() &gt; 0);
        System.assertEquals('Cannot delete account with related opportunities.',
                             result.getErrors()[0].getMessage());
    }        
}</pre></div>
</div>
<div class="section"><h3 class="helpHead3" id="Tdxn4tBK-heading6">Testing for Different Conditions</h3>
<p class="p">One test method is not enough to test all the possible inputs for the trigger. We need to
                test some other conditions, such as when an account without opportunities is
                deleted. We also need to test the same scenarios with a bulk number of records
                instead of just a single record. Here is an updated version of the test class that
                contains the three additional test methods. Save this updated version of the
                class.</p>
<div class="codeblock"><pre>@isTest
private class TestAccountDeletion {

    @isTest static void TestDeleteAccountWithOneOpportunity() {
        // Test data setup
        // Create one account with one opportunity by calling a utility method
        Account[] accts = TestDataFactory.createAccountsWithOpps(1,1);
        
        // Perform test
        Test.startTest();
        Database.DeleteResult result = Database.delete(accts[0], false);
        Test.stopTest();

        // Verify that the deletion should have been stopped by the trigger,
        // so check that we got back an error.
        System.assert(!result.isSuccess());
        System.assert(result.getErrors().size() &gt; 0);
        System.assertEquals('Cannot delete account with related opportunities.',
                             result.getErrors()[0].getMessage());
    }
    
    @isTest static void TestDeleteAccountWithNoOpportunities() {
        // Test data setup
        // Create one account with no opportunities by calling a utility method
        Account[] accts = TestDataFactory.createAccountsWithOpps(1,0);
        
        // Perform test
        Test.startTest();
        Database.DeleteResult result = Database.delete(accts[0], false);
        Test.stopTest();

        // Verify that the deletion was successful
        System.assert(result.isSuccess());
    }
    
    @isTest static void TestDeleteBulkAccountsWithOneOpportunity() {
        // Test data setup
        // Create accounts with one opportunity each by calling a utility method
        Account[] accts = TestDataFactory.createAccountsWithOpps(200,1);
        
        // Perform test
        Test.startTest();
        Database.DeleteResult[] results = Database.delete(accts, false);
        Test.stopTest();

        // Verify for each record.
        // In this case the deletion should have been stopped by the trigger,
        // so check that we got back an error.
        for(Database.DeleteResult dr : results) {
            System.assert(!dr.isSuccess());
            System.assert(dr.getErrors().size() &gt; 0);
            System.assertEquals('Cannot delete account with related opportunities.',
                                 dr.getErrors()[0].getMessage());
        }
    }
    
    @isTest static void TestDeleteBulkAccountsWithNoOpportunities() {
        // Test data setup
        // Create accounts with no opportunities by calling a utility method
        Account[] accts = TestDataFactory.createAccountsWithOpps(200,0);
        
        // Perform test
        Test.startTest();
        Database.DeleteResult[] results = Database.delete(accts, false);
        Test.stopTest();

        // For each record, verify that the deletion was successful
        for(Database.DeleteResult dr : results) {
            System.assert(dr.isSuccess());
        }
    }
}</pre></div>
</div>
<div class="section"><h3 class="helpHead3" id="Tdxn4tBK-heading7">Running All Test Methods</h3>
<p class="p">The final step is to run the test methods in our test class, now that the class contains
                more comprehensive tests and has been refactored to use a test data factory. Since
                you’ve already run the tests in the <samp>TestAccountDeletion</samp> class, you
                can just rerun this test class to run all its test methods.</p>
<ol class="ol enumList">
<li class="li">To execute the same test run, click the <strong class="ph uicontrol">Tests</strong> tab, select your
                    test run, and then click <span class="ph menucascade"><strong class="ph uicontrol">Test</strong> | <strong class="ph uicontrol">Rerun</strong></span>.</li>
<li class="li">Check the results in the Tests tab by expanding the latest test run. The test run should
                    report that all four tests passed!</li>
</ol>
</div>
</div>
</div>
<div class="topic nested0" id="apex_testing_data_resources" lang="en-us" xml:lang="en-us" xmlns:xml="http://www.w3.org/XML/1998/namespace"><a name="apex_testing_data_resources"></a>
<h2 class="helpHead2" id="Tdxn4tBK-heading8"><span class="ph" id="topic-title"><a name="topic-title"></a>Resources</span></h2>
<div class="body">
<div class="section"><h3 class="helpHead3" id="Tdxn4tBK-heading9">Documentation</h3>
<p class="p"><a class="xref" href="https://developer.salesforce.com/docs/atlas.en-us.206.0.apexcode.meta/apexcode/apex_testing_utility_classes.htm" target="_blank" title="HTML (New Window)"><em class="ph i">Apex Developer Guide</em>: Common Test Utility Classes for Test Data
Creation</a></p>
</div>
<div class="box message info"><div class="inner"><div class="bd"><div class="media"><img class="img mtm" src="https://res.cloudinary.com/hy4kyit2a/image/upload/doc/trailhead/en-usc504a262d3ae7aa180918396b7c09a71.png"/><div class="mediaBd"><p>Remember, this module is meant for
            Salesforce Classic. When you launch your hands-on org, <a class="xref" href="https://help.salesforce.com/articleView?id=lex_switching_uis.htm&amp;language=en_US" target="_blank">switch to Salesforce Classic</a> to complete this
            challenge.</p></div></div></div></div></div>
</div>
</div>
</body></div>